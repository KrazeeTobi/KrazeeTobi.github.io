<HTML>
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
   <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (Win95; I) [Netscape]">
   <TITLE>Unintended Grouping of Arithmetic</TITLE>
</HEAD>
<BODY>
<A NAME="Top"></A><A HREF="cpp.html">Contents</A>|<A HREF="cppindex.html">Index</A>|<A HREF="cppImproperly_Nested_Constructs.html">Previous</A>|<A HREF="cppSwallowing_the_Semicolon.html">Next</A>
<BR><A NAME="off_492923"></A><A NAME="8a0d6db7"></A><A NAME="off_492923"></A><A NAME="8a0d6db7"></A><A NAME="off_492923"></A><A NAME="8a0d6db7"></A><A NAME="off_492923"></A><A NAME="8a0d6db7"></A><A NAME="off_492923"></A><A NAME="8a0d6db7"></A><FONT FACE="Futura Md BT"><FONT COLOR="#000000"><B><FONT SIZE=+3>Unintended
grouping of arithmetic&nbsp;</FONT></B>&nbsp;</FONT></FONT>
<HR SIZE=6 WIDTH="100%">
<BR><FONT FACE="Times New Roman"><FONT COLOR="#000000"><FONT SIZE=+1>You
may have noticed that in most of the macro definition examples, each occurrence
of a macro argument name had parentheses around it. In addition, another
pair of parentheses usually surround the entire macro definition. The following
is why it is best to write macros that way.</FONT></FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT COLOR="#000000"><FONT SIZE=+1>Suppose
you define a macro as follows.</FONT></FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>#define ceil_div(x, y) (x + y - 1) / y</FONT></FONT></PRE>
</UL>
<FONT COLOR="#000000"><FONT FACE="Times New Roman"><FONT SIZE=+1>This produces
macro output whose purpose is to divide, rounding up. (One use for this
operation is to compute how many </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>int</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
objects are needed to hold a certain number of </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>char</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
objects.) Then suppose it is used as follows.</FONT></FONT></FONT>
<UL>
<PRE><B><FONT FACE="Courier New"><FONT SIZE=+1>a = ceil_div (b &amp; c, sizeof (int));</FONT></FONT></B></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT COLOR="#000000"><FONT SIZE=+1>This expands
into output like the following.</FONT></FONT></FONT>
<UL>
<PRE><B><FONT FACE="Courier New"><FONT SIZE=+1>a = (b &amp; c + sizeof (int) - 1) / sizeof (int);</FONT></FONT></B></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT COLOR="#000000"><FONT SIZE=+1>This output
does not do what is intended. The operator-precedence rules of C make it
equivalent to an operation like the following.</FONT></FONT></FONT>
<UL>
<PRE><B><FONT FACE="Courier New"><FONT SIZE=+1>a = (b &amp; (c + sizeof (int) - 1)) / sizeof (int);</FONT></FONT></B></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT COLOR="#000000"><FONT SIZE=+1>But what
we want is the following result.</FONT></FONT></FONT>
<UL>
<PRE><B><FONT FACE="Courier New"><FONT SIZE=+1>a = ((b &amp; c) + sizeof (int) - 1)) / sizeof (int);</FONT></FONT></B></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT COLOR="#000000"><FONT SIZE=+1>This would
mean defining the macro as the following.</FONT></FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>#define ceil_div(x, y) ((x) + (y) - 1) / (y)</FONT></FONT></PRE>
</UL>
<FONT COLOR="#000000"><FONT FACE="Times New Roman"><FONT SIZE=+1>This provides
the desired result. However, unintended grouping can result in another
way. Consider </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>sizeof
ceil_div(1, 2)</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>.
That has the appearance of a C expression that would compute the size of
the type of </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>ceil_div
(1, 2)</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>, but in
fact it means something very different. Use the following output as an
example of how it expands.</FONT></FONT></FONT>
<UL>
<PRE><B><FONT FACE="Courier New"><FONT SIZE=+1>sizeof ((1) + (2) - 1) / (2)</FONT></FONT></B></PRE>
</UL>
<FONT COLOR="#000000"><FONT FACE="Times New Roman"><FONT SIZE=+1>This would
take the size of an integer and divide it by two. The precedence rules
have put the division outside the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>sizeof</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
when it was intended to be inside.</FONT></FONT></FONT>

<P><FONT COLOR="#000000"><FONT FACE="Times New Roman"><FONT SIZE=+1>Parentheses
around the entire macro definition can prevent such problems. What follows,
then, is the recommended way to define </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>ceil_div</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>.</FONT></FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>#define ceil_div(x, y) (((x) + (y) - 1) / (y))</FONT></FONT></PRE>
</UL>

<HR SIZE=3 WIDTH="100%">
<CENTER><A HREF="#Top">Top</A>|<A HREF="cpp.html">Contents</A>|<A HREF="cppindex.html">Index</A>|<A HREF="cppImproperly_Nested_Constructs.html">Previous</A>|<A HREF="cppSwallowing_the_Semicolon.html">Next</A></CENTER>

</BODY>
</HTML>
