<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" content="Mozilla/4.51 [en] (Win95; I) [Netscape]">
   <title>crt0, the main startup file</title>
</head>
<body>
<a NAME="Top"></a><a href="emb.html">Contents</a>|<a href="embindex.html">Index</a>|<a href="embcrt0.html">Previous</a>|<a href="embThe_linker_script.html">Next</a>
<br><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><a NAME="off_100122"></a><a NAME="f52d62d1"></a><b><font color="#000000"><font size=+3><tt>crt0</tt><font face="Futura Md BT">,
the main startup file&nbsp;</font></font></font></b>
<hr SIZE=6 WIDTH="100%">
<br><font color="#000000"><font face="Times New Roman"><font size=+1>The
</font></font><font face="Courier New"><font size=+0>crt0</font></font><font face="Times New Roman"><font size=+1>
(C RunTime 0) file contains the initial startup code.</font></font></font>
<p><font color="#000000"><font face="Times New Roman"><font size=+1>Cygnus
provides a </font></font><font face="Courier New"><font size=+0>crt0</font></font><font face="Times New Roman"><font size=+1>
file, although you may want to write your own </font></font><font face="Courier New"><font size=+0>crt0</font></font><font face="Times New Roman"><font size=+1>
file for each target.</font></font></font><font face="Times New Roman"><font color="#000000"><font size=+1></font></font></font>
<p><font color="#000000"><font face="Times New Roman"><font size=+1>The
</font></font><font face="Courier New"><font size=+0>crt0</font></font><font face="Times New Roman"><font size=+1>
file is usually written in assembler as ‘</font></font><font face="Courier New"><font size=+0>crt0.S</font></font><font face="Times New Roman"><font size=+1>’,
and its object gets linked in first and bootstraps the rest of your application.</font></font></font><font face="Times New Roman"><font color="#000000"><font size=+1></font></font></font>
<p><font color="#000000"><font face="Times New Roman"><font size=+1>The
</font></font><font face="Courier New"><font size=+0>crt0</font></font><font face="Times New Roman"><font size=+1>
file defines a special symbol like </font></font><font face="Courier New"><font size=+0>_start</font></font><font face="Times New Roman"><font size=+1>
that is both the default base address for the application and the first
symbol in the executable binary image.</font></font></font>
<p><font color="#000000"><font face="Times New Roman"><font size=+1>If
you plan to use any routines from the standard C library, you’ll also need
to implement the functions on which </font></font><font face="Courier New"><font size=+0>libgloss</font></font><font face="Times New Roman"><font size=+1>
depends.</font></font></font><font face="Times New Roman"><font color="#000000"><font size=+1></font></font></font>
<p><font color="#000000"><font face="Times New Roman"><font size=+1>The
</font></font><font face="Courier New"><font size=+0>crt0</font></font><font face="Times New Roman"><font size=+1>
file accomplishes the following results.</font></font></font>
<ul>
<ul>
<ul>
<li>
<font size=+1><a href="#Initialize"><tt>crt0</tt><i><font face="Times New Roman">initializes
everything in your program that needs it</font></i></a></font></li>

<li>
<font size=+1><a href="#0bss"><tt>crt0</tt><i><font face="Times New Roman">
zeroes the </font></i><tt>.bss</tt><i><font face="Times New Roman"> section</font></i></a></font></li>

<li>
<font size=+1><a href="#main()"><tt>crt0</tt><i><font face="Times New Roman">
calls </font></i><tt>main()</tt></a></font></li>

<li>
<font size=+1><a href="#exit"><tt>crt0</tt><i><font face="Times New Roman">
calls </font></i><tt>(exit)</tt></a></font></li>
</ul>
</ul>
</ul>
<font face="Times New Roman"><font color="#000000"><font size=+1>See also
<a href="embIO_support_code.html">I/O
support code</a>.</font></font></font>
<ul TYPE=SQUARE>
<li>
<a NAME="Initialize"></a><b><font size=+1><tt>crt0</tt><i><font face="Times New Roman">initializes
everything in your program that needs it</font></i></font></b></li>

<br><font face="Times New Roman"><font size=+1>This initialization section
varies. If you are developing an application that gets downloaded to a
ROM monitor, there is usually no need for special initialization because
the ROM monitor handles it for you. If you plan to burn your code in a
ROM, the crt0 file typically does all of the hardware initialization required
to run an application. This can include things like initializing serial
ports and running a memory check; however, results vary depending on your
hardware.</font></font>
<p><font face="Times New Roman"><font size=+1>The following is a typical
basic initialization of </font></font><font face="Courier New"><font size=+0>crt0.S</font></font><font face="Times New Roman"><font size=+1>.</font></font>
<p><font face="Arial"><font size=+1>1.</font></font>
<br><font face="Times New Roman"><font size=+1>Set up concatenation macros.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>#define CONCAT1(a, b) CONCAT2(a, b)&nbsp;
#define CONCAT2(a, b) a ## b</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>Later, you’ll use these macros.</font></font>
<p><font face="Arial"><font size=+1>2.</font></font>
<br><font face="Times New Roman"><font size=+1>Set up label macros, using
the following example’s input.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>#ifndef __USER_LABEL_PREFIX__&nbsp;
#define __USER_LABEL_PREFIX__ _&nbsp;
#endif</font></font></pre>

<pre><font face="Courier New"><font size=+1>#define SYM(x) CONCAT1 (__USER_LABEL_PREFIX__, x)</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>These macros make the code portable
between ‘</font></font><font face="Courier New"><font size=+0>coff</font></font><font face="Times New Roman"><font size=+1>’
and ‘</font></font><font face="Courier New"><font size=+0>a.out</font></font><font face="Times New Roman"><font size=+1>’.
‘</font></font><font face="Courier New"><font size=+0>coff</font></font><font face="Times New Roman"><font size=+1>’
always has an </font></font><font face="Courier New"><font size=+0>__</font></font><font face="Times New Roman"><font size=+1>
(underline) prepended to the front of its global symbol names. ‘</font></font><font face="Courier New"><font size=+0>a.out</font></font><font face="Times New Roman"><font size=+1>’
has none.</font></font>
<p><font face="Arial"><font size=+1>3.</font></font>
<br><font face="Times New Roman"><font size=+1>Set up register names (with
the right prefix), using the following example’s input.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>#ifndef __REGISTER_PREFIX__&nbsp;
#define __REGISTER_PREFIX__&nbsp;
#endif</font></font></pre>

<pre><font face="Courier New"><font size=+1>/* Use the right prefix for registers. */&nbsp;
#define REG(x) CONCAT1 (__REGISTER_PREFIX__, x)</font></font></pre>

<pre><font face="Courier New"><font size=+1>#define d0 REG (d0)&nbsp;
#define d1 REG (d1)&nbsp;
#define d2 REG (d2)&nbsp;
#define d3 REG (d3)&nbsp;
#define d4 REG (d4)&nbsp;
#define d5 REG (d5)&nbsp;
#define d6 REG (d6)&nbsp;
#define d7 REG (d7)&nbsp;
#define a0 REG (a0)&nbsp;
#define a1 REG (a1)&nbsp;
#define a2 REG (a2)&nbsp;
#define a3 REG (a3)&nbsp;
#define a4 REG (a4)&nbsp;
#define a5 REG (a5)&nbsp;
#define a6 REG (a6)&nbsp;
#define fp REG (fp)&nbsp;
#define sp REG (sp)</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>Register names are for portability
between assemblers. Some register names have a </font></font><font face="Courier New"><font size=+0>%</font></font><font face="Times New Roman"><font size=+1>
or </font></font><font face="Courier New"><font size=+0>$</font></font><font face="Times New Roman"><font size=+1>
prepended to them.</font></font>
<p><font face="Arial"><font size=+1>4.</font></font>
<br><font face="Times New Roman"><font size=+1>Set up space for the stack
and grab a chunk of memory.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>.set stack_size, 0x2000 .&nbsp;
comm SYM (stack), stack_size</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>This can also be done in the
linker script, but it typically gets done at this point.</font></font>
<p><font face="Arial"><font size=+1>5.</font></font>
<br><font face="Times New Roman"><font size=+1>Define an empty space for
the environment, using the following example’s input.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>&nbsp;&nbsp;&nbsp;&nbsp; .data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp; .align 2&nbsp;
SYM (environ):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp; .long 0</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>This is bogus on almost any
ROM monitor, but we set up a valid address for it and pass the address
to </font></font><font face="Courier New"><font size=+0>main ()</font></font><font face="Times New Roman"><font size=+1>.
This way, if an application checks for an empty environment, it finds one.</font></font>
<p><font face="Arial"><font size=+1>6.</font></font>
<br><font face="Times New Roman"><font size=+1>Set up a few global symbols
that get used elsewhere.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>.align 2&nbsp;
.text&nbsp;
.global SYM (stack)</font></font></pre>

<pre><font face="Courier New"><font size=+1>.global SYM (main)&nbsp;
.global SYM (exit)&nbsp;
.global __bss_start</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>This really should be</font></font><font face="Courier New"><font size=+0>
__bss_start</font></font><font face="Times New Roman"><font size=+1>, not
</font></font><font face="Courier New"><font size=+0>SYM
(__bss_start). __bss_start</font></font><font face="Times New Roman"><font size=+1>
needs to be declared this way because its value is set in the linker script.</font></font>
<p><font face="Arial"><font size=+1>7.</font></font>
<br><font face="Times New Roman"><font size=+1>Set up the global symbol,
</font></font><font face="Courier New"><font size=+0>start</font></font><font face="Times New Roman"><font size=+1>,
for the linker to use as the default address for the </font></font><font face="Courier New"><font size=+0>.text</font></font><font face="Times New Roman"><font size=+1>
section. This helps your program run.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>SYM (start):&nbsp;
link a6, #-8&nbsp;
moveal #SYM (stack) + stack_size, sp</font></font></pre>
</ul>

<li>
<a NAME="0bss"></a><b><font size=+1><font face="Courier New">crt0</font><i><font face="Times New Roman">
zeroes the </font></i><font face="Courier New">.bss</font><i><font face="Times New Roman">
section</font></i></font></b></li>

<br><font face="Times New Roman"><font size=+1>Make sure the </font></font><font face="Courier New"><font size=+0>.bss</font></font><font face="Times New Roman"><font size=+1>
section is cleared for uninitialized data, using the following example’s
input. All of the addresses in the </font></font><font face="Courier New"><font size=+0>.bss
</font></font><font face="Times New Roman"><font size=+1>section
need to be initialized to zero so programs that forget to check new variables’
default values will get predictable results.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>moveal #__bss_start, a0&nbsp;
moveal #SYM (end), a1&nbsp;
1:&nbsp;
movel #0, (a0)&nbsp;
leal 4(a0), a0&nbsp;
cmpal a0, a1&nbsp;
bne 1b</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>Applications can get wild side
effects from the </font></font><font face="Courier New"><font size=+0>.bss</font></font><font face="Times New Roman"><font size=+1>
section being left uncleared, and it can cause particular problems with
some implementations of </font></font><font face="Courier New"><font size=+0>malloc()</font></font><font face="Times New Roman"><font size=+1>.</font></font>
<br>&nbsp;
<li>
<a NAME="main()"></a><b><font size=+1><font face="Courier New">crt0</font><i><font face="Times New Roman">
calls </font></i><font face="Courier New">main()</font></font></b></li>

<br><font face="Times New Roman"><font size=+1>If your ROM monitor supports
it, set up </font></font><font face="Courier New"><font size=+0>argc</font></font><font face="Times New Roman"><font size=+1>
and </font></font><font face="Courier New"><font size=+0>argv</font></font><font face="Times New Roman"><font size=+1>
for command line arguments and an environment pointer before the call to
</font></font><font face="Courier New"><font size=+0>main()</font></font><font face="Times New Roman"><font size=+1>,
using the following example’s input.</font></font>
<p><font face="Times New Roman"><font size=+1>For G++, the code generator
inserts a branch to </font></font><font face="Courier New"><font size=+0>__main</font></font><font face="Times New Roman"><font size=+1>
at the top of your </font></font><font face="Courier New"><font size=+0>main()</font></font><font face="Times New Roman"><font size=+1>
routine. G++ uses </font></font><font face="Courier New"><font size=+0>__main</font></font><font face="Times New Roman"><font size=+1>
to initialize its internal tables and then returns control to your </font></font><font face="Courier New"><font size=+0>main()</font></font><font face="Times New Roman"><font size=+1>
routine.</font></font>
<p><font size=+1><font face="Times New Roman">For </font><tt>crt0</tt><font face="Times New Roman">
to call your </font></font><font face="Courier New"><font size=+0>main()</font></font><font face="Times New Roman"><font size=+1>
routine, use the following example’s input. First, set up the environment
pointer and jump to </font></font><font face="Courier New"><font size=+0>main()</font></font><font face="Times New Roman"><font size=+1>.
Call the main routine from the application to get it going, using the following
example’s input with </font></font><font face="Courier New"><font size=+0>main
(argc, argv, environ)</font></font><font face="Times New Roman"><font size=+1>using
</font></font><font face="Courier New"><font size=+0>argv</font></font><font face="Times New Roman"><font size=+1>
as a pointer to NULL.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pea 0&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pea SYM (environ)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pea sp@(4)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pea 0&nbsp;
jsr SYM (main)&nbsp;
movel d0, sp@-4</font></font></pre>
</ul>

<li>
<a NAME="exit"></a><b><font size=+1><font face="Courier New">crt0</font><i><font face="Times New Roman">
calls </font></i><font face="Courier New">(exit)</font></font></b></li>

<br><font face="Times New Roman"><font size=+1>After </font></font><font face="Courier New"><font size=+0>main()</font></font><font face="Times New Roman"><font size=+1>
has run, the crt0 file cleans things up and returns control of the hardware
from the application. On some hardware there is nothing to return to—especially
if your program is in ROM— and if that’s the case, you need to do a hardware
reset or branch back to the original start address.</font></font>
<p><font face="Times New Roman"><font size=+1>If you’re using a ROM monitor,
you can usually call a user trap to make the ROM take over. Pick a safe
vector with no sides effects. Some ROM’s have a built-in trap handler just
for this case.</font></font>
<p><font face="Times New Roman"><font size=+1>Implementing </font></font><font face="Courier New"><font size=+0>(exit)</font></font><font face="Times New Roman"><font size=+1>
here is easy.. First, with </font></font><font face="Courier New"><font size=+0>_exit</font></font><font face="Times New Roman"><font size=+1>,
exit from the application. Normally, this causes a user trap to return
to the ROM monitor for another run. Then, using the following example’s
input, you proceed with the call.</font></font>
<ul TYPE=SQUARE>
<pre><font face="Courier New"><font size=+1>SYM (exit):&nbsp;
trap #0</font></font></pre>
</ul>
<font face="Times New Roman"><font size=+1>Both </font></font><font face="Courier New"><font size=+0>rom68k</font></font><font face="Times New Roman"><font size=+1>
and </font></font><font face="Courier New"><font size=+0>bug</font></font><font face="Times New Roman"><font size=+1>
can handle a user-caused exception of </font></font><font face="Courier New"><font size=+0>0</font></font><font face="Times New Roman"><font size=+1>
with no side effects. Although the </font></font><font face="Courier New"><font size=+0>bug</font></font><font face="Times New Roman"><font size=+1>
monitor has a user-caused trap that returns control to the ROM monitor,
the </font></font><font face="Courier New"><font size=+0>bug</font></font><font face="Times New Roman"><font size=+1>
monitor is more portable.</font></font></ul>

<center>
<hr SIZE=3 WIDTH="100%">
<br><a href="#Top">Top</a>|<a href="emb.html">Contents</a>|<a href="embindex.html">Index</a>|<a href="embcrt0.html">Previous</a>|<a href="embThe_linker_script.html">Next</a></center>

</body>
</html>
