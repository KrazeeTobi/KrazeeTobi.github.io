<HTML>
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
   <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (Win95; I) [Netscape]">
   <TITLE>Global Declarations and VMS</TITLE>
</HEAD>
<BODY>
<A NAME="Top"></A><A HREF="gcc.html">Contents</A>|<A HREF="gccindex.html">Index</A>|<A HREF="gccInclude_Files_and_VMS.html">Previous</A>|<A HREF="gccOther_VMS_Issues.html">Next</A>
<BR><A NAME="off_5537792"></A><A NAME="b73dd7c2"></A><FONT FACE="Futura Md BT"><FONT COLOR="#000000"><B><FONT SIZE=+3>Global
declarations and VMS&nbsp;</FONT></B>&nbsp;</FONT></FONT>
<HR SIZE=6 WIDTH="100%">
<BR><FONT FACE="Times New Roman"><FONT SIZE=+1>GNU CC does not provide
the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>globalref</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>,
</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>globaldef</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
and </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>globalvalue</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
keywords of VAX-C. You can get the same effect with an obscure feature
of GAS, the GNU assembler. (This requires GAS version 1.39 or later.) The
following macros allow you to use this feature in a fairly natural way.</FONT></FONT>
<UL>
<PRE><FONT SIZE=+1><FONT FACE="Courier New">#ifdef __GNUC__&nbsp;
#define GLOBALREF(TYPE,NAME)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; TYPE NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; asm (</FONT><FONT FACE="Times New Roman">“</FONT><FONT FACE="Courier New">_$$PsectAttributes_GLOBALSYMBOL$$</FONT><FONT FACE="Times New Roman">”</FONT><FONT FACE="Courier New"> #NAME)&nbsp;
#define GLOBALDEF(TYPE,NAME,VALUE)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; TYPE NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; asm (</FONT><FONT FACE="Times New Roman">“</FONT><FONT FACE="Courier New">_$$PsectAttributes_GLOBALSYMBOL$$</FONT><FONT FACE="Times New Roman">”</FONT><FONT FACE="Courier New"> #NAME)&nbsp; \&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = VALUE&nbsp;
#define GLOBALVALUEREF(TYPE,NAME)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; const TYPE NAME[1]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; asm (</FONT><FONT FACE="Times New Roman">“</FONT><FONT FACE="Courier New">_$$PsectAttributes_GLOBALVALUE$$</FONT><FONT FACE="Times New Roman">”</FONT><FONT FACE="Courier New"> #NAME)&nbsp;
#define GLOBALVALUEDEF(TYPE,NAME,VALUE)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; const TYPE NAME[1]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; asm (</FONT><FONT FACE="Times New Roman">“</FONT><FONT FACE="Courier New">_$$PsectAttributes_GLOBALVALUE$$</FONT><FONT FACE="Times New Roman">”</FONT><FONT FACE="Courier New"> #NAME)&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = {VALUE}&nbsp;
#else&nbsp;
#define GLOBALREF(TYPE,NAME)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; globalref TYPE NAME&nbsp;
#define GLOBALDEF(TYPE,NAME,VALUE)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; globaldef TYPE NAME = VALUE&nbsp;
#define GLOBALVALUEDEF(TYPE,NAME,VALUE)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; globalvalue TYPE NAME = VALUE&nbsp;
#define GLOBALVALUEREF(TYPE,NAME)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;
&nbsp;&nbsp; globalvalue TYPE NAME&nbsp;
#endif</FONT></FONT></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT SIZE=+1>(The ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>_$$PsectAttributes_GLOBALSYMBOL</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
prefix at the start of the name is removed by the assembler, after it has
modified the attributes of the symbol). These macros are provided in the
VMS binaries distribution in a header file ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GNU_HACKS.H</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’.
An example of the usage is the following.</FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>GLOBALREF (int, ijk);&nbsp;
GLOBALDEF (int, jkl, 0);</FONT></FONT></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT SIZE=+1>The macros </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALREF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
and </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALDEF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
cannot be used straightforwardly for arrays, since there is no way to insert
the array dimension into the declaration at the right place. However, you
can declare an array with these macros if you first define a typedef for
the array type, like the following input.</FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>typedef int intvector[10];&nbsp;
GLOBALREF (intvector, foo);</FONT></FONT></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT SIZE=+1>Array and structure initializers
will also break the macros; you can define the initializer to be a macro
of its own, or you can expand the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALDEF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
macro by hand. You may find a case where you wish to use the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALDEF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
macro with a large array, but you are not interested in explicitly initializing
each element of the array. In such cases you can use an initializer like:
‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>{0,}</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
’, which will initialize the entire array to ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>0</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>A shortcoming of this implementation
is that a variable declared with </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALVALUEREF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
or </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALVALUEDEF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
is always an array.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>For example, the following
declaration declares the variable, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>ijk</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’,
as an array of type, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>int
[1]</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’.</FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>GLOBALVALUEREF(int, ijk);</FONT></FONT></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT SIZE=+1>This is done because a globalvalue
is actually a constant; its <I>value</I> is what the linker would normally
consider an address. That is not how an integer value works in C, but it
is how an array works. So treating the symbol as an array name gives consistent
results—with the exception that the value seems to have the wrong type.
<B><I>Don’t try to access an element of the array</I></B>. It doesn’t have
any elements. The array <I>address</I> may not be the address of actual
storage.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>The fact that the symbol
is an array may lead to warnings where the variable is used. Insert type
casts to avoid the warnings. Here is an example; it takes advantage of
the ANSI C feature allowing macros that expand to use the same name as
the macro itself.</FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>GLOBALVALUEREF (int, ss$_normal);&nbsp;
GLOBALVALUEDEF (int, xyzzy,123);&nbsp;
#ifdef __GNUC__&nbsp;
#define ss$_normal ((int) ss$_normal)&nbsp;
#define xyzzy ((int) xyzzy)&nbsp;
#endif</FONT></FONT></PRE>
</UL>
<FONT FACE="Times New Roman"><FONT SIZE=+1>Don’t use </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALDEF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
or </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALREF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
with a variable whose type is an enumeration type; this is not implemented.
Instead, make the variable an integer, and use a </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>GLOBALVALUEDEF</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
for each of the enumeration values. An example of this would be the following.</FONT></FONT>
<UL>
<PRE><FONT FACE="Courier New"><FONT SIZE=+1>#ifdef __GNUC__&nbsp;
GLOBALDEF (int, color, 0);&nbsp;
GLOBALVALUEDEF (int, RED, 0);&nbsp;
GLOBALVALUEDEF (int, BLUE, 1);&nbsp;
GLOBALVALUEDEF (int, GREEN, 3);&nbsp;
#else&nbsp;
enum globaldef color {RED, BLUE, GREEN = 3};&nbsp;
#endif</FONT></FONT></PRE>
</UL>

<PRE>
<HR SIZE=3 WIDTH="100%"></PRE>

<CENTER><A HREF="#Top">Top</A>|<A HREF="gcc.html">Contents</A>|<A HREF="gccindex.html">Index</A>|<A HREF="gccInclude_Files_and_VMS.html">Previous</A>|<A HREF="gccOther_VMS_Issues.html">Next</A></CENTER>

<PRE></PRE>

</BODY>
</HTML>
