<HTML>
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
   <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (Win95; I) [Netscape]">
   <TITLE>Generating Dependencies Automatically</TITLE>
</HEAD>
<BODY>
<A NAME="Top"></A><A HREF="make.html">Contents</A>|<A HREF="makeindex.html">Index</A>|<A HREF="makeDoubleColon_Rules.html">Previous</A>|<A HREF="makeWriting_the_Commands_in_Rules.html">Next</A>
<BR><A NAME="off_756750"></A><A NAME="74fbd19a"></A><B><FONT FACE="Futura Md BT"><FONT SIZE=+3>Generating
dependencies automatically</FONT></FONT></B>
<BR>
<HR SIZE=3 WIDTH="100%"><FONT FACE="Times New Roman"><FONT SIZE=+1>In the
makefile for a program, many of the rules you need to write often say only
that some object file depends on some header file. For example, if ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>main.c</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
uses ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>defs.h</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
via an </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>#include</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>,
you would write: </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>main.o:
defs.h</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>You need this rule so that
make knows that it must remake ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>main.o</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
whenever ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>defs.h</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
changes. You can see that for a large program you would have to write dozens
of such rules in your makefile. And, you must always be very careful to
update the makefile every time you add or remove an </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>#include</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>To avoid this hassle, most
modern C compilers can write these rules for you, by looking at the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>#include</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
lines in the source files.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>Usually this is done with
the ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>-M</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
option to the compiler. For example, the command, </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>cc
-M main.c</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>, generates
the output: </FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>main.o
: main.c defs.h</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>Thus you no longer have to
write all those rules yourself. The compiler will do it for you.</FONT></FONT>
<UL><FONT FACE="Times New Roman"><FONT SIZE=+1><I>Note</I>:</FONT></FONT>
<BR><FONT FACE="Times New Roman"><FONT SIZE=+1>Such a dependency constitutes
mentioning ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>main.o</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
in a makefile, so it can never be considered an intermediate file by implicit
rule search. This means that </FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>make</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>
won’t ever remove the file after using it; see <FONT COLOR="#008000"><A HREF="makeChains_of_Implicit_Rules.html">Chains
of implicit rules</A></FONT>.</FONT></FONT></UL>
<FONT FACE="Times New Roman"><FONT SIZE=+1>With old </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>make</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
programs, it was common practice to use this compiler feature to generate
dependencies on demand with a command like ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>make
depend</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>That command would create
a file ‘</FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>depend</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>’
containing all the automatically-generated dependencies; then the makefile
could use </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>include
</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>to read them in
(see <FONT COLOR="#008000"><A HREF="makeIncluding_Other_Makefiles.html">Including
other makefiles</A></FONT>).</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>In GNU </FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>make</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>,
the feature of remaking makefiles makes this practice obsolete—you need
never tell </FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>make</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>
explicitly to regenerate the dependencies, because it always regenerates
any makefile that is out of date. See <FONT COLOR="#008000"><A HREF="makeHow_Makefiles_Are_Remade.html">How
makefiles are remade</A></FONT>.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>The practice we recommend
for automatic dependency generation is to have one makefile corresponding
to each source file.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>For each source file, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0><I>name</I>.c</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’,
there is a makefile, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0><I>name</I>.d</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’,
listing which files on which the object file, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0><I>name</I>.o</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’,
depends.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>That way only the source
files that have changed need to be rescanned to produce the new dependencies.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>The following is an example
of the pattern rule to generate a file of dependencies (i.e., a makefile)
called ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0><I>name</I>.d</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
from a C source file called ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0><I>name</I>.c</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’.</FONT></FONT>
<BR>&nbsp;
<UL><FONT FACE="Courier New"><FONT SIZE=+0>%.d: %.c</FONT></FONT>
<BR><FONT SIZE=+0><FONT FACE="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
$(SHELL) -ec </FONT><FONT FACE="Times New Roman">’</FONT><FONT FACE="Courier New">$(CC)
-M $(CPPFLAGS) $&lt; \</FONT></FONT>
<BR><FONT SIZE=+0><FONT FACE="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
| sed </FONT><FONT FACE="Times New Roman">’</FONT><FONT FACE="Courier New">\</FONT><FONT FACE="Times New Roman">’’</FONT><FONT FACE="Courier New">s/$*\\.o[
:]*/&amp; $@/g</FONT><FONT FACE="Times New Roman">’</FONT><FONT FACE="Courier New">\</FONT><FONT FACE="Times New Roman">’’</FONT><FONT FACE="Courier New">
> $@</FONT><FONT FACE="Times New Roman">’</FONT></FONT></UL>


<P><FONT FACE="Times New Roman"><FONT SIZE=+1>See <FONT COLOR="#008000"><A HREF="makeDefining_and_Redefining_Pattern_.html">Defining
and redefining pattern rules</A></FONT> for information on defining pattern
rules. The ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>-e</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
flag to the shell makes it exit immediately if the</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>
$(CC)</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1> command
fails (exits with a nonzero status). Normally the shell exits with the
status of the last command in the pipeline (</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>sed</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
in this case), so </FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>make</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>
would not notice a nonzero status from the compiler.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>With the GNU C compiler,
you may wish to use the ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>-MM</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
flag instead of ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>-M</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>This omits dependencies on
system header files. See <A HREF="../../2_comp/Using_GNU_CC/gccOptions_Controlling_the_Preproce.html">Options
Controlling the Preprocessor</A> in <I><A HREF="../../2_comp/Using_GNU_CC/gcc.html">Using
GNU CC</A></I> in <B><I>GNUPro Compiler Tools</I></B> for details. For
example, the purpose of the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>sed</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
command is to translate </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>main.o
: main.c defs.h</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
into: </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>main.o main.d
: main.c defs.h</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>.</FONT></FONT>

<P><FONT FACE="Times New Roman"><FONT SIZE=+1>This makes each ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>.d</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
file depend on all the source and header files on which the corresponding
‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>.o</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
file depends. </FONT></FONT><B><FONT FACE="Courier New"><FONT SIZE=+0>make</FONT></FONT></B><FONT FACE="Times New Roman"><FONT SIZE=+1>
then knows it must regenerate the dependencies whenever any of the source
or header files changes. Once you’ve defined the rule to remake the ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>.d</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
files, you then use the </FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>include</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>
directive to read them all in. See <FONT COLOR="#008000"><A HREF="makeIncluding_Other_Makefiles.html">Including
other makefiles</A></FONT>. Use the following example, for clarification.</FONT></FONT>
<BR>&nbsp;
<UL><FONT FACE="Courier New"><FONT SIZE=+0>sources = foo.c bar.c</FONT></FONT>

<P><FONT FACE="Courier New"><FONT SIZE=+0>include $(sources:.c=.d)</FONT></FONT></UL>


<P><FONT FACE="Times New Roman"><FONT SIZE=+1>This example uses a substitution
variable reference to translate the list of source files, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>foo.c
bar.c</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’, into a
list of dependency makefiles, ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>foo.d
bar.d</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’. See <FONT COLOR="#008000"><A HREF="makeSubstitution_References.html">Substitution
references </A></FONT>for information on substitution references. Since
the ‘</FONT></FONT><FONT FACE="Courier New"><FONT SIZE=+0>.d</FONT></FONT><FONT FACE="Times New Roman"><FONT SIZE=+1>’
files are makefiles like any others, make will remake them as necessary
with no further work from you. See <FONT COLOR="#008000"><A HREF="makeHow_Makefiles_Are_Remade.html">How
makefiles are remade</A></FONT>.</FONT></FONT>
<CENTER>
<HR SIZE=3 WIDTH="100%"></CENTER>

<CENTER><A HREF="#Top">Top</A>|<A HREF="make.html">Contents</A>|<A HREF="makeindex.html">Index</A>|<A HREF="makeDoubleColon_Rules.html">Previous</A>|<A HREF="makeWriting_the_Commands_in_Rules.html">Next</A></CENTER>

</BODY>
</HTML>
